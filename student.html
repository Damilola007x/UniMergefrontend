<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Student - Negotiation Portal</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f172a; color: white; padding: 40px; margin: 0; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; max-width: 1100px; margin: auto; }
        .card { background: #1e293b; padding: 30px; border-radius: 12px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3); border: 1px solid #334155; }
        h2 { margin-top: 0; color: #38bdf8; font-size: 1.5rem; }
        .form-input { background: #334155; color: white; border: 1px solid #475569; padding: 12px; border-radius: 6px; margin-top: 5px; width: 100%; box-sizing: border-box; }
        .spawn-btn { background: #38bdf8; color: #0f172a; font-weight: bold; padding: 14px; border: none; border-radius: 6px; width: 100%; cursor: pointer; transition: 0.3s; margin-top: 10px; }
        .spawn-btn:hover { background: #0ea5e9; transform: translateY(-2px); }
        .console-card { display: flex; flex-direction: column; }
        .logs { background: #000; border-radius: 8px; padding: 15px; height: 350px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px; border: 1px solid #334155; }
        .sys-note { color: #64748b; font-style: italic; }
        .log-msg { color: #38bdf8; margin: 5px 0; }
        .log-success { color: #4ade80; margin: 5px 0; font-weight: bold; }
        .log-error { color: #f43f5e; margin: 5px 0; font-weight: bold; }
        .logout-btn { background: #475569; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; float: right; }
    </style>
</head>
<body>

<button class="logout-btn" onclick="location.href='index.html'">Logout</button>

<section id="student-view" class="view-panel">
    <div class="grid-2">
        <div class="card">
            <h2 id="welcome-msg">Request Exam Slot</h2>
            
            <input type="text" id="courseCode" placeholder="Course Code (e.g., CSC301)" class="form-input">

            <label style="color: #94a3b8; font-size: 0.8rem; margin-top: 10px; display: block;">Preferred Venue:</label>
            <select id="preferredVenue" class="form-input" style="width: 100%; margin-bottom: 10px;">
                <option value="Hall A">School Auditorium </option>
                <option value="Hall B">Mass-Com Auditorium</option> 
                <option value="Hall C">Multipurpose Hall</option>
                <option value="Hall A">E-Library </option>
                <option value="Hall B">Library Block A</option> 
                <option value="Hall C">Library Block B</option>
            </select>

            <label style="color: #94a3b8; font-size: 0.8rem; display: block;">Preferred Day:</label>
            <select id="preferredDay" class="form-input" style="width: 100%; margin-bottom: 20px;">
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
            </select>

            <button type="button" onclick="spawnAgent()" class="spawn-btn">Spawn Student Agent</button>
        </div>

        <div class="card console-card">
            <h2>Agent Live Feed (CNP Protocol)</h2>
            <div id="agent-logs" class="logs">
                <p class="sys-note">Waiting for Agent Spawning...</p>
            </div>
        </div>
    </div>
</section>

<script>
  /**
 * UniMerge MAS - Student Logic (student.js)
 */

// 1. Point to your LIVE backend on Render
const API_BASE_URL = "https://unimerge.onrender.com"; 

// 2. Initialize user data from localStorage
const userName = localStorage.getItem("userName") || "Student";
const loginId = localStorage.getItem("loginId"); // Matches the key used in script.js
const welcomeMsg = document.getElementById('welcome-msg');

if (welcomeMsg) {
    welcomeMsg.innerText = `Welcome, ${userName}`;
}

// 3. Trigger the Multi-Agent Negotiation
async function spawnAgent() {
    const courseRaw = document.getElementById('courseCode').value.trim();
    const course = courseRaw.replace(/\s+/g, '').toUpperCase();
    const venue = document.getElementById('preferredVenue').value;
    const day = document.getElementById('preferredDay').value;
    const logs = document.getElementById('agent-logs');

    if (!course) return alert("Please enter a course code (e.g., CSC301)");

    // Reset logs for new negotiation
    logs.innerHTML = `<p class="log-msg">[${new Date().toLocaleTimeString()}] StudentAgent: Initializing negotiation for ${course}...</p>`;

    try {
        // Updated from localhost to Render URL
        const resp = await fetch(`${API_BASE_URL}/api/schedule/negotiate`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                matricNumber: loginId, 
                courseCode: course, 
                preferredVenue: venue, 
                preferredDay: day 
            })
        });

        const result = await resp.text();

        if (result.startsWith("AGENT_SPAWNED")) {
            const p = result.split(":"); // [Status, Course, Name, Day, Venue]
            runCNP(p[1], p[3], p[4]);
        } else {
            logs.innerHTML += `<p class="log-error">[${new Date().toLocaleTimeString()}] VenueAgent: ACL_REFUSE</p>`;
            logs.innerHTML += `<p class="log-error">REASON: ${result}</p>`;
            // Alert the user to the specific reason (e.g., Blacklisted day or Wrong course)
            alert(result);
        }
    } catch (e) {
        console.error(e);
        logs.innerHTML += `<p class="log-error">CONNECTION ERROR: Ensure Render backend is LIVE.</p>`;
    }
}

// 4. Contract Net Protocol (CNP) Visual Simulation
function runCNP(course, day, venue) {
    const logs = document.getElementById('agent-logs');
    
    setTimeout(() => { 
        logs.innerHTML += `<p class="log-msg">StudentAgent -> VenueAgent: ACL_CFP (Requesting slot for ${course})</p>`;
        logs.scrollTop = logs.scrollHeight;
    }, 800);

    setTimeout(() => { 
        logs.innerHTML += `<p class="log-msg">VenueAgent -> StudentAgent: ACL_PROPOSE (Proposed: ${venue} on ${day})</p>`;
        logs.scrollTop = logs.scrollHeight;
    }, 2200);

    setTimeout(() => { 
        logs.innerHTML += `<p class="log-success">StudentAgent: ACL_ACCEPT_PROPOSAL</p>`;
        logs.scrollTop = logs.scrollHeight;
    }, 3500);

    setTimeout(() => { 
        logs.innerHTML += `<p class="log-success">VenueAgent: ACL_INFORM (Negotiation Finalized for ${course})</p>`;
        logs.scrollTop = logs.scrollHeight;
        showDownloadBtn(course, day, venue);
    }, 5000);
}

// 5. Generate Exam Slip
function showDownloadBtn(c, d, v) {
    const logs = document.getElementById('agent-logs');
    const btn = document.createElement('button');
    btn.innerText = "ðŸ“¥ Download Exam Slip";
    btn.className = "spawn-btn";
    btn.style.background = "#10b981";
    btn.style.marginTop = "15px";
    
    btn.onclick = () => {
         const win = window.open('', '_blank');
         win.document.write(`
            <div style="border:10px solid #38bdf8; padding:30px; font-family:sans-serif; text-align:center; max-width:500px; margin:auto;">
                <h1 style="color:#1e293b;">UniMerge MAS</h1>
                <h2>Official Exam Slip</h2>
                <hr>
                <p><strong>Student Name:</strong> ${userName}</p>
                <p><strong>Matric Number:</strong> ${loginId}</p>
                <p><strong>Course Code:</strong> ${c}</p>
                <p><strong>Assigned Venue:</strong> ${v}</p>
                <p><strong>Scheduled Day:</strong> ${d}</p>
                <br>
                <p style="color:#10b981; font-weight:bold;">VERIFIED BY AGENT NEGOTIATION</p>
                <small>Generated on: ${new Date().toLocaleString()}</small>
            </div>
         `);
         win.document.close();
         win.print();
    };
    logs.appendChild(btn);
}
</script>

</body>
</html>